<html>
<head>

<style>
#status {
	height: 150px;
}
</style>

<script src="resources/jquery-3.3.1.js"></script>
<script>

$(document).ready( function() {
    let playerName = prompt('Please player, enter you name:','Default');

	// initial state of the game
	let state = {fuel: 100, food: 0, planet: 'Earth'};
	let maxF = 100;
	let gameIsRunning = true;

	// the display that will show what happens
	$('#status').html( 'Status: ' + JSON.stringify(state) );

	function quit(){
		$('#status').html( 'You logged out! ' +
							'HighScore: ...' + state.food );
		gameIsRunning = false;
		enterBtn.disabled = true;
		quitBtn.disabled = true;

        $.getJSON( "JSON/highscores.json", function( data ) {
            console.log( 'the result:' , data);
            //$('#status').append('<br>'+JSON.stringify(data));

            let scoreObj = data.filter( (element)=> element.username == playerName);
            let scoreValue = 0;
            if (scoreObj.length>=1){
                scoreValue = scoreObj[0].bestScore;
            }

            if (state.food > scoreValue){
            		alert(`Congratulations you just surpassed your previous highscore! \n old = ${scoreValue} ; new = ${state.food}`
								);
            }
        })
	}

	//$('#enterBtn').on('click', function(){
	$('#enterBtn').click( ()=>{
		let text = `Player ${playerName}: your status is now ${JSON.stringify(state)}`;

		switch( $('#userInput').val().toUpperCase() ){
			case 'SEARCH':{
				let dice = Math.floor(Math.random()*6)+1;
				if (dice<=3){
					text += '<br/>you searched on ' + state.planet + ' and found something...';
					dice = Math.floor(Math.random()*6)+1;
					if (dice==1){
            text += '<br/>... fuel.'
            if ((state.fuel + dice) < maxF){
						state.fuel += Math.floor(Math.random()*6)+1;
            }
						else {
            	state.fuel = maxF;
            }
					}
					if ((dice==2) || (dice==3)) {
						text += '<br/>... food!';
						state.food += Math.floor(Math.random()*6)+1;
						//state.xp += Math.floor(Math.random()*6)+1;
					}
				}
				else {
					text += '<br/>you found nothing on ' + state.planet + '.';
				}
			} break;
      case 'MOVE':{
        	let dice = Math.floor(Math.random()*6)+1;
        	let roll = Math.floor(Math.random()*6)+1; //Cost of travel
    			if (state.fuel <= roll) {
        			state.planet = 'Earth';
          		text += '<br/>you ran out of fuel and moved back to Earth.';
              state.fuel = maxF;
        	}
					else {
        			if (dice<=3){
          			state.planet = 'Jupiter';
                state.fuel -= roll;
        			}
        			if (dice>3){
          			state.planet = 'Venus';
                state.fuel -= roll;
        			}
              text += '<br/>you moved to ' + state.planet + '.';
        		}
      } break;
			case 'RETURN HOME':{
					text += '<br/>you are home!';
					state.fuel = maxF;
					state.planet ='Earth';
			} break;
			default: {
				text += '<br/>...command not recognized...';
			}
		}
		$('#status').html( text );
	});

	$('input:submit').on('click',function(evt){
		evt.preventDefault();
		console.log( 'submitting form with Ajax...' );

		$.ajax({
			type: "POST",
			url: "https://sdu-task1-realtimeweb.herokuapp.com:3000/",
			dataType: "json",
			data: JSON.stringify({
								playerName;
								$(state.food);
								})

		})/*.done(function ( data ) {
			console.log( data );

			let elements = $();
			for(let i=0; i<data.length;i++) {
				elements = elements.add('<li>'+data[i].timeStamp + '|'+ data[i].item +'</li>');
			}
			$('#todolist').empty();
			$('#todolist').append(elements);
			$('#the_text').val('');
		});*/

		quit();
		return;
	});
});
</script>

<title>SpaceShip</title>
</head>
<body>
	<h1>SpaceShip</h1>
  	<img
	src= ' /img/cookies-in-space.jpg';
	height=250px;
	width=400px; />
	<p>

		<p><h2>Situation</h2>
        <div>Instructions - use these commands to play:
            <br>SEARCH, MOVE, RETURN HOME
            <br>And click QUIT to finish the game.
        </div>
		<div id="status">...</div>
		</p>

		<hr/>

		<b>What do you want to do? (search/move/return home)</b>
		<br/>
		<input type="text" id="userInput" />
		<button type="button" id="enterBtn">ENTER</button><br />

		<form method="POST">
		<input type="submit" value="QUIT" id="quitBtn"/>
		</form>

		<script>
			var input = document.getElementById("userInput");
			input.addEventListener("keyup", function(event) {
				if (event.keyCode === 13) {
					event.preventDefault();
					document.getElementById("enterBtn").click();
  				}
			});
		</script>
	</p>

</body>
</html>
