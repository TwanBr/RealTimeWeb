<!doctype html>
<html>
  <head>
    <title>SpaceShip</title>
    <style>
      .left, .right {
        height:100%; position:fixed; z-index:1;top:0;overflow-x:hidden;padding-top:5px;
      }
      .left {
        width:70%;
        left: 0;
      }
      .right {
        width:30%;
        right: 0;
        background:lightgray;
      }

      * { margin: 0; padding: 10px; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { height:10%; border: 0; padding: 10px; width: 25%; margin-right: 0.2%;}
      form button { width: 4.8%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }

      $status {
        height:150px;
      }
    </style>

    <script type="text/javascript" src="/resources/jquery-3.3.1.js"></script>
      <script src="/socket.io/socket.io.js"></script>
      <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
    $(document).ready( function() {
      let playerName = prompt('Please player, enter you name:','Twan');

    	// initial state of the game
    	let maxFuel = 100;
    	let gameIsRunning = true;
        let state = {fuel: 100, minerals: 0 , planet: 'Earth', flag: 'NO'};

        function start (){
            $.ajax({
            type:"POST",
            url: "/start",
            dataType: "json",
            data: JSON.stringify ({username: playerName})
        }).done(function(data){
           let playerObj = data.filter( (element)=> element.username == playerName);
            console.log(playerObj);
            if (playerObj.length>=1){
                state.fuel = playerObj[0].fuel;
                state.minerals= playerObj[0].minerals;
                /*state.planet=playerObj[0].planet;*/
                state.flag= playerObj[0].flag;
            }
             $('#status').html(`${playerName}, your status is: ${JSON.stringify(state)}`);
        });
        };

        start ();



      /*$('#status').html(`${playerName}, your status is: ${JSON.stringify(state)}`);*/

    	function quit(){
    				$('#status').html( 'You logged out! ' + 'Score: ...' + state.minerals );
    				gameIsRunning = false;
    				enterBtn.disabled = true;
    				quitBtn.disabled = true;

        		$.ajax({
    						type: "POST",
    						url: "/quit",
    						dataType: "json",
    						data: JSON.stringify({username: playerName, bestScore: state.minerals})
    				}).done(function ( data ) {

    						let scoreObj = data.filter( (element)=> element.username == playerName);
    			 			console.log(scoreObj);
    			 			let scoreValue =0;
    			 			if (scoreObj.length>=1){
    			 				scoreValue = scoreObj[0].bestScore;
    			 			}
    			 			console.log(scoreValue);
    			 			if(state.food >= scoreValue){
    			 			 		console.log("higher");
    			 			 		alert(`Congratulations you just surpassed your previous highscore! Your new highscore is ${state.food}`);
    			 			}
    			 			else {
    			 			 		console.log("lower");
    			 			 		alert(`You failed to surpass your highscore of ${scoreValue}. \n Better luck next time...`);
    			 			}
    				});
            $.ajax({
                type: "POST",
                url:"/save",
                dataType: "json",
                data: JSON.stringify({username: playerName, fuel: state.fuel, minerals: state.minerals, /*planet: state.planet,*/ flag: state.flag})
            });
      	};

        var p= new Boolean;
        var f= new Boolean;
        function updatePlanetData(){
    				 $.ajax({
    				 		type: "POST",
    				 		url: "/update",
    				 		dataType: "json",
    				 		data: JSON.stringify({planetName: state.planet, foundMinerals: foundMinerals})
    				}).done(function (data){
                let planetObj = data.filter (( element)=> element.planetName==state.planet);
                console.log(planetObj);
                console.log(foundMinerals);
                if (planetObj[0].planetMinerals >= foundMinerals && planetObj[0].flag=="YES"){
                    p = true;
                    f= true;
                } else if (planetObj[0].planetMinerals >= foundMinerals && planetObj[0].flag=="NO"){
                    p = true;
                    f= false;
                } else {
                    p= false;
                    f=false;
                }
;
                return (p , f);
            });
    		};


    	$('#enterBtn').click( ()=>{


    		let statetext = ``;
    		let text = "";


    		switch( $('#userInput').val().toUpperCase() ){
    			case 'SEARCH':{
    				let dice = Math.floor(Math.random()*6)+1;
    				if (dice<=4){
    						foundMinerals = Math.floor(Math.random()*6)+1;
    						//var sufficient = "";

    				updatePlanetData();
                    console.log(p);
                        if (p==true && f==false) {
                            text += '<br />You searched on ' + state.planet + ' and found ' + foundMinerals + ' minerals!';
    								state.minerals += foundMinerals;
                        }
                        else if (p==true && f==true) {
                            text += '<br /> You searched on ' + state.planet + ' and found ' + foundMinerals + ' minerals! Congrats, this planet has a flag on it, these minerals will be multiplied by 2!';
                            state.minerals += foundMinerals*2;
                        }
                        else if (p==false) {
                            text += '<br />You thought you found something, but there are not enough minerals left on ' + state.planet;
                        }

    						//return;
    				} else {
    						text += '<br />You found nothing on ' + state.planet + '.';
    				}
    			} break;
          case 'MOVE':{
            	let dice = Math.floor(Math.random()*6)+1;
            	let roll = Math.floor(Math.random()*6)+1; //Cost of travel
        			if (state.fuel <= roll) {
            			state.planet = 'Earth';
              		text += '<br />You ran out of fuel and moved back to Earth.';
                  state.fuel = maxFuel;
            	}
    					else {
            			/*if (dice<=3){
              			state.planet = 'Jupiter';
                    state.fuel -= roll;
            			}
            			if (dice>3){
              			state.planet = 'Venus';
                    state.fuel -= roll;
            			}*/
                    state.fuel-=roll;
                            state.planet='Venus';
                  text += '<br />You moved to ' + state.planet + '.';
            		}
              var data = {
                    user:playerName,
                    planet: state.planet,
                    message: 'exit_Earth',
                    type:'userMessage'
      };
              socket.send(JSON.stringify(data));
            console.log(data);

          } break;
    			case 'RETURN HOME':{
    					text += '<br />You are home!';
    					state.fuel = maxFuel;
    					state.planet ='Earth';
                    var data = {
                    user:playerName,
                    planet: state.planet,
                    message: 'exit_Venus',
                    type:'userMessage'
    			};
                    socket.send(JSON.stringify(data));
            console.log(data);
                } break;
    			default: {
    				text += '<br />...This command is not recognised...';
    			}
    		}

    		statetext += `${playerName}, your status is: ${JSON.stringify(state)}`;
    		$('#status').html( statetext + text );
        });

    	$('input:submit').on('click',function(){

    		quit();

    		return;
    	});

        $('#send').click(()=>{
      var data = {
          user: playerName,
         planet: state.planet,
         message: $('#message').val(),
         type:'userMessage'
      };
      socket.send(JSON.stringify(data));
      console.log("send message to server");
      $('#message').val('');

   });
    let socket = io.connect('/');

   socket.on('message', (data)=>{
      var dataObj = JSON.parse(data);
       console.log(dataObj);
      $('#messages').append('<div class="'+dataObj.type+'">' +dataObj.user +' : '+ dataObj.message + '</div>');
   });
    });

    </script>

  </head>
  <body>
    <div class="row">
        <div class="left">
          <h1>SpaceShip</h1>
        	<p>

        		<p><h2>Situation</h2>
                <div>Instructions - use these commands to play:
                    <br />SEARCH, MOVE, RETURN HOME
                    <br />And click QUIT to finish the game.
                    <br />
                </div>
        		<div id="status">...</div>
        		</p>

        		<hr/>

        		<b>What do you want to do? (search/move/return home)</b>
        		<br/>
        		<input type="text" id="userInput" />
        		<button type="button" id="enterBtn">ENTER</button><br />

        		<form method="POST">
        		<input type="submit" value="QUIT AND SAVE" id="quitBtn"/>
        		</form>

        		<script>
        			var input = document.getElementById("userInput");
        			input.addEventListener("keyup", function(event) {
        				if (event.keyCode === 13) {
        					event.preventDefault();
        					document.getElementById("enterBtn").click();
          				}
        			})
        		</script>
        	</p>
        </div>
        <div class="right">
            <div id="Planet"></div>
            <div id="messages"></div>
            <input id="message" type="text" placeholder="Enter your message here"></input>
            <input id="send" type="button" value="Send"></input>

        </div>
    </div>
  </body>
</html>
